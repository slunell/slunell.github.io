<!DOCTYPE html>
<html>

<head>
    <meta charset=utf-8>
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link rel="shortcut icon" type="image/x-icon" href="img/sl_icon.ico" />
    <title>Audio Visualizer App</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            /* full window width */
            text-align: center;
        }

        #body-color {
            background-color: black;
        }

        canvas {
            width: 100%;
            height: 100%;
        }

        img {
            width: 1.5em;
            height: 1.5em;
        }

        audio::-webkit-media-controls-panel {
            background-color: rgba(0, 0, 0, 0);
        }

        input[type=file]::-webkit-file-upload-button {
            background-color: grey;
            color: black;
            font-family: helvetica;
            visibility: hidden;
        }

        audio::-webkit-media-controls-volume-slider {
            display: none;
        }

        audio::-webkit-media-controls-mute-button {
            display: none;
        }

        #play {
            font-family: arial;
            color: silver;
            background-color: black;
            padding-left: 2em;
            vertical-align: text-bottom;
        }

        #play>span {
            vertical-align: sub;
        }

        #play>span:hover {
            cursor: pointer;
        }

        #choose {
            width: 0%;
            display: inline-block;
            float: left;
        }

        #begin {
            width: 8%;
            display: inline-block;
            float: left;
            margin-top: 1%;
        }

        #panel {
            display: inline-block;
            float: left;
            margin-top: 0.2%;
        }

        #search {
            cursor: pointer;

        }

        #music-files {
            width: 0;
            height: 0;
            position: fixed;
        }



        #first-div {
            margin-left: 1em;
        }

        @media only screen and (max-width: 500px) {
            #image {
                margin-left: 2.7em;
            }


        }

        @media only screen and (min-width: 500px) {
            #header-style {
                position: fixed;
            }

            #image {
                margin-left: 4.5em;
            }
        }

        #audio-player {
            width: 200px;
            height: 35px;
            display: inline-block;
            margin-left: 10px;
        }

        #timeline {
            width: 100%;
            height: 3px;
            margin-top: 29px;
            float: left;
            border-radius: 15px;
            background-color: lightgray;
        }

        #playhead {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-top: -5px;
            background-color: lightgray;
        }

        #image {
            width: 18px;
            height: 20px;
            display: inline-block;
            margin-top: -2px
        }
    </style>

    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

</head>

<body id="body-color">
    <div class="container-fluid">
        <div class="row" id="header-style">
            <div class="col pt-2" id="first-div">
                <img id="search" src="../img/search.png" onclick="document.getElementById('music-files').click();" />

                <audio id="music"></audio>
                <input type="file" id="music-files" multiple accept="audio/*" />
                <img src="img/play.png" id="image" onclick="play()">

                <div id="audio-player">
                    <div id="timeline">
                        <div id="playhead"></div>
                    </div>
                </div>
            </div>


        </div>
    </div>
    <script>
        var music = document.getElementById("music");
        var playhead = document.getElementById("playhead");
        var timelineWidth = $("#timeline").width();
        var duration = music.duration;



        music.addEventListener("timeupdate", timeUpdate, false);


        function timeUpdate() {
            var playPercent = timelineWidth * (music.currentTime / music.duration);
            playhead.style.marginLeft = playPercent + "px";
        }

        timeline.addEventListener("click", function(event) {
            moveplayhead(event);
            music.currentTime = duration * clickPercent(event);
        }, false);

        function clickPercent(event) {
            return (event.clientX - getPosition(timeline)) / timelineWidth;
        }

        var onplayhead = false;

        function mouseUp(event) {
            if (onplayhead == true) {
                moveplayhead(event);
                window.removeEventListener('mousemove', moveplayhead, true);
                // change current time
                music.currentTime = duration * clickPercent(event);
                music.addEventListener('timeupdate', timeUpdate, false);
            }
            onplayhead = false;
        }

        function moveplayhead(event) {
            var newMargLeft = event.clientX - getPosition(timeline);

            if (newMargLeft >= 0 && newMargLeft <= timelineWidth) {
                playhead.style.marginLeft = newMargLeft + "px";
            }
            if (newMargLeft < 0) {
                playhead.style.marginLeft = "0px";
            }
            if (newMargLeft > timelineWidth) {
                playhead.style.marginLeft = timelineWidth + "px";
            }
        }

        music.addEventListener("canplaythrough", function() {
            duration = music.duration;
        }, false);

        function moveplayhead(event) {
            var newMargLeft = event.clientX - getPosition(timeline);

            if (newMargLeft >= 0 && newMargLeft <= timelineWidth) {
                playhead.style.marginLeft = newMargLeft + "px";
            }
            if (newMargLeft < 0) {
                playhead.style.marginLeft = "0px";
            }
            if (newMargLeft > timelineWidth) {
                playhead.style.marginLeft = timelineWidth + "px";
            }
        }

        function getPosition(el) {
            return el.getBoundingClientRect().left;
        }
    </script>
    <script src="../js/three.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <div class="container">
        <script>
            var ratio = window.innerHeight / window.innerWidth;
            window.addEventListener('resize', function() {
                renderer.setSize(window.innerWidth * .99, window.innerWidth * ratio * .99);
            });

            window.onload = function(e) {
                document.getElementById('music-files').addEventListener('change', selectMusic, false);
                animateStart();
            }



            var musicFiles = [];
            var audioCtx = new(window.AudioContext || window.webkitAudioContext)();
            var audio;
            var audioSrc;
            var analyser;
            var bufferLength;
            var dataArray = new Uint8Array(1024);
            var myAudio = document.getElementById('music');

            function selectMusic(e) {
                musicFiles = e.target.files;
            }

            function getFreq() {
                requestAnimationFrame(getFreq);
                analyser.getByteFrequencyData(dataArray);
            }

            function play() {

                if (music.paused) {
                    $("#image").attr("src", "img/pause.png");

                } else {
                    $("#image").attr("src", "img/play.png");
                    music.pause();
                    return;
                }

                if (musicFiles.length > 0) {
                    var num = Math.floor(Math.random() * musicFiles.length);
                    var musicFile = URL.createObjectURL(musicFiles[num]);
                    $("#music").attr("src", musicFile);
                } else {
                    $("#music").attr("src", "mp3/seven.mp3");
                }




                document.getElementById('music').play();

                audio = document.getElementById('music');
                audioSrc = audioCtx.createMediaElementSource(audio);
                analyser = audioCtx.createAnalyser();
                audioSrc.connect(analyser);
                audioSrc.connect(audioCtx.destination);
                bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);
                getFreq();
                animate();
            }

            function isPaused(audelem) {
                return audelem.paused;
            }

            var scene = new THREE.Scene();
            var camera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 0.1, 1000);

            var renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth * .99, window.innerHeight * .99);
            document.body.appendChild(renderer.domElement);

            var geometry = new THREE.BoxGeometry(1, 1, 1);
            var material = new THREE.MeshBasicMaterial({
                color: "#130c96"
            });
            var material1 = new THREE.MeshBasicMaterial({
                color: "purple"
            });
            var material2 = new THREE.MeshBasicMaterial({
                color: "rebeccapurple"
            });
            var material3 = new THREE.MeshBasicMaterial({
                color: "midnightblue"
            });

            var cube = new THREE.Mesh(geometry, material);
            var cube1 = new THREE.Mesh(geometry, material1);
            var cube2 = new THREE.Mesh(geometry, material2);
            var cube3 = new THREE.Mesh(geometry, material3);

            scene.add(cube);
            scene.add(cube1);
            scene.add(cube2);
            scene.add(cube3);

            camera.position.z = 5;

            function animateStart() {
                requestAnimationFrame(animateStart);
                cube.scale = cube1.scale = cube2.scale = cube3.scale = 1;


                cube.rotation.x += 0.011;
                cube.rotation.y += 0.011;

                cube1.rotation.x -= 0.011;
                cube1.rotation.y -= 0.011;

                cube2.rotation.x += 0.006;
                cube2.rotation.y += 0.006;

                cube3.rotation.x -= 0.006;
                cube3.rotation.y -= 0.006;

                renderer.render(scene, camera);
            }


            function animate() {

                requestAnimationFrame(animate);

                if (isPaused(myAudio)) {

                    cube.scale.set(1, 1, 1);
                    cube1.scale.set(1, 1, 1);
                    cube2.scale.set(1, 1, 1);
                    cube3.scale.set(1, 1, 1);

                    cube.rotation.x += 0.011;
                    cube.rotation.y += 0.011;

                    cube1.rotation.x -= 0.011;
                    cube1.rotation.y -= 0.011;

                    cube2.rotation.x += 0.006;
                    cube2.rotation.y += 0.006;

                    cube3.rotation.x -= 0.006;
                    cube3.rotation.y -= 0.006;

                } else {

                    cube.scale.set(0.025, 0.025, 0.025);
                    cube1.scale.set(0.025, 0.025, 0.025);
                    cube2.scale.set(0.025, 0.025, 0.025);
                    cube3.scale.set(0.025, 0.025, 0.025);

                    for (var i = 0; i < dataArray.length; i++) {

                        cube.scale.x += Math.pow(dataArray[i], 1.15) / 100000;
                        cube.scale.y += Math.pow(dataArray[i], 1.15) / 100000;
                        cube.scale.z += Math.pow(dataArray[i], 1.15) / 100000;

                        cube1.scale.x += Math.pow(dataArray[i], 1.15) / 100000;
                        cube1.scale.y += Math.pow(dataArray[i], 1.15) / 100000;
                        cube1.scale.z += Math.pow(dataArray[i], 1.15) / 100000;

                        cube2.scale.x += Math.pow(dataArray[i], 1.15) / 100000;
                        cube2.scale.y += Math.pow(dataArray[i], 1.15) / 100000;
                        cube2.scale.z += Math.pow(dataArray[i], 1.15) / 100000;

                        cube3.scale.x += Math.pow(dataArray[i], 1.15) / 100000;
                        cube3.scale.y += Math.pow(dataArray[i], 1.15) / 100000;
                        cube3.scale.z += Math.pow(dataArray[i], 1.15) / 100000;
                    }

                    cube.rotation.x += 0.01;
                    cube.rotation.y += 0.01;

                    cube1.rotation.x -= 0.01;
                    cube1.rotation.y -= 0.01;

                    cube2.rotation.x += 0.005;
                    cube2.rotation.y += 0.005;

                    cube3.rotation.x -= 0.005;
                    cube3.rotation.y -= 0.005;

                }

                renderer.render(scene, camera);

            }
        </script>
    </div>
</body>

</html>
